<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Codificaci√≥n de caracteres y viewport -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Informaci√≥n b√°sica del sitio -->
    <title>Demon Slayer</title>
    <meta name="description" content="Sitio web sobre Demon Slayer: Kimetsu no Yaiba">

    <!-- Icono de la pesta√±a -->
    <link rel="shortcut icon" type="image/png" href="favicon/favicon-512.png">

    <!-- Color de la aplicaci√≥n -->
    <meta name="theme-color" content="#FB314E">

    <!-- Optimizaci√≥n para m√≥vil -->
    <meta name="MobileOptimized" content="width">
    <meta name="HandheldFriendly" content="true">

    <!-- Meta etiquetas para Apple -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="favicon/favicon-1024.png">
    <link rel="apple-touch-startup-image" href="favicon/favicon-512.png">

    <!-- Manifest para PWA -->
    <link rel="manifest" href="./manifest.json">

    <!-- Hojas de estilo -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/alertify.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/css/themes/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">

    <!-- Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVeQZ2181GM2V1rSXMZe6zXCbLp7wyQnc",
            authDomain: "aplicacion-pwa.firebaseapp.com",
            projectId: "aplicacion-pwa",
            storageBucket: "aplicacion-pwa.firebasestorage.app",
            messagingSenderId: "233398149796",
            appId: "1:233398149796:web:5100ccb51eb742ba3efc31",
            measurementId: "G-GBEM1H5TMJ"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const messaging = getMessaging(app);

        async function initializeFirebaseMessaging() {
            try {
                console.log('üöÄ Inicializando Firebase Messaging...');

                // Verificar compatibilidad
                if (!await isSupported()) {
                    console.warn('Navegador no compatible con FCM');
                    return null;
                }

                // Registrar Service Worker
                const registration = await navigator.serviceWorker.register('./sw.js', {
                    scope: './'
                });
                console.log('‚úÖ Service Worker registrado');

                // Esperar activaci√≥n
                if (registration.installing) {
                    await new Promise((resolve) => {
                        registration.installing.addEventListener('statechange', (e) => {
                            if (e.target.state === 'activated') {
                                console.log('‚úÖ Service Worker activado');
                                resolve();
                            }
                        });
                    });
                }

                // Obtener token FCM - CON LA CLAVE CORRECTA
                console.log('üì° Solicitando token FCM...');
                const token = await getToken(messaging, {
                    serviceWorkerRegistration: registration,
                    vapidKey: 'BM4lWb5Is9MHFKZp9QZ0UMbmjti0_je-xhtRk709SA7zB0NkmjWC0LE72Y0XG_maBxywov7OQXG9dI_OjaIXFxo'  // ‚Üê CLAVE CORRECTA
                });

                if (token) {
                    console.log('üéâ TOKEN FCM OBTENIDO:', token);
                    await sendTokenToServer(token);
                    return messaging;
                } else {
                    console.log('‚ùå No se pudo obtener token FCM');
                    return null;
                }

            } catch (error) {
                console.error('üí• Error en Firebase Messaging:', error);
                return null;
            }
        }

        async function sendTokenToServer(token) {
            try {
                const response = await fetch('save_subscription.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: token })
                });

                const data = await response.json();
                if (data.success) {
                    console.log('üíæ Token guardado en servidor');
                } else {
                    console.warn('‚ö†Ô∏è Error guardando token:', data.message);
                }
            } catch (error) {
                console.error('‚ùå Error enviando token:', error);
            }
        }

        // Inicializaci√≥n cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', async () => {
            if (!('serviceWorker' in navigator)) {
                console.warn('‚ùå Service Workers no soportados');
                return;
            }

            if (!('Notification' in window)) {
                console.warn('‚ùå Notificaciones no soportadas');
                return;
            }

            try {
                // Solicitar permiso
                const permission = await Notification.requestPermission();
                console.log('üîî Permiso de notificaciones:', permission);

                if (permission === 'granted') {
                    console.log('üéâ Permiso concedido! Inicializando FCM...');
                    const messagingInstance = await initializeFirebaseMessaging();

                    if (messagingInstance) {
                        // Configurar mensajes en primer plano
                        onMessage(messagingInstance, (payload) => {
                            console.log('üì® Mensaje en primer plano:', payload);

                            // Mostrar notificaci√≥n personalizada
                            if (payload.notification) {
                                const { title, body, icon } = payload.notification;
                                new Notification(title || 'Nueva notificaci√≥n', {
                                    body: body || '',
                                    icon: icon || './favicon/favicon-192.png'
                                });
                            }
                        });

                        console.log('‚úÖ Firebase Messaging completamente inicializado');
                    }
                } else {
                    console.log('‚ùå Permiso de notificaciones denegado por el usuario');
                }
            } catch (error) {
                console.error('üí• Error inicializando notificaciones:', error);
            }
        });
    </script>
</head>

<body>
    <header id="main-header">
        <div class="container">
            <div id="logo">
                <h1>Demon Slayer</h1>
            </div>
            <div id="menu">
                <ul>
                    <li><a href="#main-header">Inicio</a></li>
                    <li><a href="#services">Personajes</a></li>
                    <li><a href="#videos">Videos</a></li>
                    <li><a href="#footer">Contacto</a></li>
                </ul>
            </div>
        </div>
    </header>
    <div class="clearfix"></div>

    <div id="slider">
        <div class="container">
            <h2>Kimetsu no Yaiba</h2>
        </div>
    </div>

    <div id="services">
        <div class="container">
            <h2 class="subheader">Personajes principales</h2>

            <div class="service">
                <img src="img/1.jpg" alt="Tanjiro Kamado" />
                <h3>Tanjiro Kamado</h3>
                <p>El protagonista de la serie, un joven amable y decidido que busca salvar a su hermana Nezuko y vengar
                    a su familia.</p>
            </div>
            <div class="service">
                <img src="img/2.jpeg" alt="Nezuko Kamado" />
                <h3>Nezuko Kamado</h3>
                <p>La hermana menor de Tanjiro, convertida en demonio, pero que conserva su humanidad y lucha junto a su
                    hermano.</p>
            </div>
            <div class="service">
                <img src="img/3.jpg" alt="Zenitsu Agatsuma" />
                <h3>Zenitsu Agatsuma</h3>
                <p>Un cazador de demonios con un car√°cter cobarde, pero que se transforma en un guerrero poderoso cuando
                    est√° dormido.</p>
            </div>
        </div>
    </div>

    <div class="clearfix"></div>
    <div id="videos">
        <div class="container">
            <h2 class="subheader">Videos destacados</h2><br>
            <div class="video">
                <iframe width="560" height="315" src="https://www.youtube.com/embed/VQGCKyvzIM4" frameborder="0"
                    allowfullscreen></iframe>
                <p>Tr√°iler oficial de Demon Slayer: Kimetsu no Yaiba.</p>
            </div>
            <div class="clearfix"></div> <!-- Separador -->
            <div class="video">
                <iframe width="560" height="315" src="https://www.youtube.com/embed/ATJYac_dORw" frameborder="0"
                    allowfullscreen></iframe>
                <p>Escena √©pica de la batalla contra Rui.</p>
            </div>
            <div class="clearfix"></div> <!-- Separador -->
            <div class="video">
                <iframe width="560" height="315" src="https://www.youtube.com/embed/1iBnWJKbvHI" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
                <p>Opening de la primera temporada: "Gurenge" de LiSA.</p>
            </div>
        </div>
    </div>

    <div class="clearfix"></div>
    <footer id="footer">
        <div class="container">
            <h2 class="subheader">Contacto</h2>
            <p>¬øTienes alguna consulta? Escr√≠benos usando el formulario de contacto.</p>
            <form id="contact-form" aria-label="Formulario de contacto">
                <div class="form-row">
                    <label for="nombre">Nombre</label>
                    <input type="text" id="nombre" name="nombre" required />
                </div>
                <div class="form-row">
                    <label for="apellidos">Apellidos</label>
                    <input type="text" id="apellidos" name="apellidos" required />
                </div>
                <div class="form-row">
                    <label for="edad">Edad</label>
                    <input type="number" id="edad" name="edad" min="1" max="120" required />
                </div>
                <div class="form-row full">
                    <label for="mensaje">Mensaje</label>
                    <textarea id="mensaje" name="mensaje" rows="4" required></textarea>
                </div>
                <div class="form-row full">
                    <button type="submit">Enviar</button>
                </div>
                <div id="form-message" role="status" aria-live="polite"></div>
            </form>
            <div class="clearfix"></div>
        </div>
    </footer>
    <!-- Contenedor de notificaciones (usado por implementaciones antiguas, puede permanecer vac√≠o) -->
    <div id="toast-container" aria-live="polite" aria-atomic="true" style="display:none"></div>

    <!-- Script personalizado -->
    <script src="main.js"></script>
</body>

</html>